<html>
    <head>
        <title>KoS Standings</title>
        <style>
            * {font-family: sans-serif;color:#fff;background:#000;}
            h1 {text-align:center;font-size:300%;background:#fff;color:#000;margin:0;padding:15px 0;}
            h2 {margin:15px 0 0 20px;}
            body {width: 100%; overflow: hidden;}
            table {border-spacing:0;width:100%;padding:20px;}
            td, th {padding:5px;}
            th {background:#999;color:#000;}
            tbody tr:nth-child(even) td {background:#111;}
            div {width:50%;padding:0;margin:0;}
            #matches {float:left;}
            #standings {float:right;}
            #matches table :last-child, #standings table :nth-last-child(-n+4){text-align:right;}
            th, td {text-align:left;}
        </style>
        <script type="text/javascript" src="../functions.js"></script>
    </head>
    <body>
        <h1>Standings</h1>
        <div id="matches">
            <h2>Matches</h2>
            <table>
                <thead>
                    <tr>
                        <th></th>
                        <th>Team 1</th>
                        <th>Team 2</th>
                        <th>Map</th>
                        <th>Score</th>
                    </tr>
                </thead>
                <tbody id="match_list"></tbody>
            </table>
        </div>
        <div id="standings">
            <h2>Players</h2>
            <table>
                <thead>
                    <tr>
                        <th></th>
                        <th>Player</th>
                        <th>Wins</th>
                        <th>Rounds Won</th>
                        <th>Rounds Lost</th>
                        <th>Round Differential</th>
                    </tr>
                </thead>
                <tbody id="player_list"></tbody>
            </table>
        </div>
        <script type="text/javascript">
            const urlParams = new URLSearchParams(window.location.search);
            var tournament = urlParams.get('tournament');
            if (!tournament)
                tournament = 1;
            function get_scores(){
                load('//data.kingofsiege.com/matches?tournament=' + tournament, function(matches){
                    var match_list = document.getElementById('match_list');
                    var players = {};
                    match_list.innerHTML = '';
                    for (var match_number in matches){
                        var match = matches[match_number];
                        for (var i in match.players){
                            var player = match.players[i];
                            if (!players[player.name])
                                players[player.name] = {name: player.name, wins:0, rounds_for:0, rounds_against:0};
                            if (i < 2 && match.score1){
                                if (match.score1 > match.score2)
                                    players[player.name].wins += 1;
                                players[player.name].rounds_for += match.score1;
                                players[player.name].rounds_against += match.score2;
                            }
                            else if (match.score1){
                                if (match.score1 < match.score2)
                                    players[player.name].wins += 1;
                                players[player.name].rounds_for += match.score2;
                                players[player.name].rounds_against += match.score1;
                            }
                        }
                        var html = '<tr>\n';
                        html += '<td>' + ((match_number/1) + 1) + '</td>\n';
                        html += '<td>' + match.players[0].name + ' &amp; ' + match.players[1].name + '</td>\n';
                        html += '<td>' + match.players[2].name + ' &amp; ' + match.players[3].name + '</td>\n';
                        html += '<td>' + match.map + '</td>\n';
                        if (match.score1)
                            html += '<td>' + match.score1 + ' - ' + match.score2 + '</td>\n';
                        else
                            html += '<td></td>';
                        html += '</tr>';
                        match_list.innerHTML += html;
                    }

                    var player_list = document.getElementById('player_list');
                    player_list.innerHTML = '';
                    var table = [];
                    for (var name in players){
                        var player = players[name];
                        table.push([name, player.wins, player.rounds_for, player.rounds_against, player.rounds_for - player.rounds_against]);
                    }
                    table.sort(function(a,b){
                        var wins = b[1] - a[1];
                        var diff = b[4] - a[4];
                        var rounds = b[2] - a[2];
                        if (wins)
                            return wins;
                        if (diff)
                            return diff;
                        if (rounds)
                            return rounds;
                    });

                    for (var i in table){
                        var row = table[i];
                        var html = '<tr>\n';
                        html += '<td>' + ((i/1) + 1) + '</td>\n';
                        for (var col of row)
                            html += '<td>' + col + '</td>\n';
                        html += '</tr>';
                        player_list.innerHTML += html;
                    }

                    setTimeout(get_scores, 5000);
                });
            }

            get_scores();
        </script>
    </body>
</html>
